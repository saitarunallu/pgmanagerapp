<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PG Commission Manager</title>
  <style>
    /* Design System CSS Variables */
    :root {
      --color-white: rgba(255, 255, 255, 1);
      --color-black: rgba(0, 0, 0, 1);
      --color-cream-50: rgba(252, 252, 249, 1);
      --color-cream-100: rgba(255, 255, 253, 1);
      --color-gray-200: rgba(245, 245, 245, 1);
      --color-gray-300: rgba(167, 169, 169, 1);
      --color-gray-400: rgba(119, 124, 124, 1);
      --color-slate-500: rgba(98, 108, 113, 1);
      --color-brown-600: rgba(94, 82, 64, 1);
      --color-charcoal-700: rgba(31, 33, 33, 1);
      --color-charcoal-800: rgba(38, 40, 40, 1);
      --color-slate-900: rgba(19, 52, 59, 1);
      --color-teal-300: rgba(50, 184, 198, 1);
      --color-teal-400: rgba(45, 166, 178, 1);
      --color-teal-500: rgba(33, 128, 141, 1);
      --color-teal-600: rgba(29, 116, 128, 1);
      --color-teal-700: rgba(26, 104, 115, 1);
      --color-red-400: rgba(255, 84, 89, 1);
      --color-red-500: rgba(192, 21, 47, 1);
      --color-orange-400: rgba(230, 129, 97, 1);
      --color-orange-500: rgba(168, 75, 47, 1);
      --color-brown-600-rgb: 94, 82, 64;
      --color-teal-500-rgb: 33, 128, 141;
      --color-slate-900-rgb: 19, 52, 59;
      --color-slate-500-rgb: 98, 108, 113;
      --color-bg-1: rgba(59, 130, 246, 0.08);
      --color-bg-2: rgba(245, 158, 11, 0.08);
      --color-bg-3: rgba(34, 197, 94, 0.08);
      --color-bg-4: rgba(239, 68, 68, 0.08);
      --color-background: var(--color-cream-50);
      --color-surface: var(--color-cream-100);
      --color-text: var(--color-slate-900);
      --color-text-secondary: var(--color-slate-500);
      --color-primary: var(--color-teal-500);
      --color-primary-hover: var(--color-teal-600);
      --color-primary-active: var(--color-teal-700);
      --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
      --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
      --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
      --color-border: rgba(var(--color-brown-600-rgb), 0.2);
      --color-btn-primary-text: var(--color-cream-50);
      --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
      --color-error: var(--color-red-500);
      --color-success: var(--color-teal-500);
      --color-warning: var(--color-orange-500);
      --font-family-base: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      --font-size-sm: 12px;
      --font-size-base: 14px;
      --font-size-lg: 16px;
      --font-size-xl: 18px;
      --font-size-2xl: 20px;
      --font-size-3xl: 24px;
      --font-weight-normal: 400;
      --font-weight-medium: 500;
      --font-weight-semibold: 550;
      --font-weight-bold: 600;
      --space-4: 4px;
      --space-8: 8px;
      --space-12: 12px;
      --space-16: 16px;
      --space-20: 20px;
      --space-24: 24px;
      --space-32: 32px;
      --radius-sm: 6px;
      --radius-base: 8px;
      --radius-md: 10px;
      --radius-lg: 12px;
      --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --color-background: var(--color-charcoal-700);
        --color-surface: var(--color-charcoal-800);
        --color-text: var(--color-gray-200);
        --color-text-secondary: rgba(167, 169, 169, 0.7);
        --color-primary: var(--color-teal-300);
        --color-primary-hover: var(--color-teal-400);
        --color-btn-primary-text: var(--color-slate-900);
        --color-border: rgba(119, 124, 124, 0.3);
        --color-card-border: rgba(119, 124, 124, 0.2);
        --color-error: var(--color-red-400);
        --color-success: var(--color-teal-300);
        --color-warning: var(--color-orange-400);
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family-base);
      font-size: var(--font-size-base);
      color: var(--color-text);
      background-color: var(--color-background);
      line-height: 1.5;
    }

    .app {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background-color: var(--color-surface);
      border-right: 1px solid var(--color-border);
      padding: var(--space-24);
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      transition: transform 0.3s ease;
      z-index: 1000;
    }

    .sidebar-header {
      margin-bottom: var(--space-32);
    }

    .sidebar-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-primary);
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: var(--space-12) var(--space-16);
      margin-bottom: var(--space-8);
      border-radius: var(--radius-base);
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--color-text);
      text-decoration: none;
    }

    .nav-item:hover {
      background-color: var(--color-secondary);
    }

    .nav-item.active {
      background-color: var(--color-primary);
      color: var(--color-btn-primary-text);
      font-weight: var(--font-weight-medium);
    }

    .nav-icon {
      margin-right: var(--space-12);
      font-size: var(--font-size-lg);
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: var(--space-24);
      width: calc(100% - 260px);
    }

    .mobile-header {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-16);
      background-color: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      position: sticky;
      top: 0;
      z-index: 999;
      margin: calc(var(--space-24) * -1) calc(var(--space-24) * -1) var(--space-24);
    }

    .hamburger {
      font-size: var(--font-size-2xl);
      cursor: pointer;
      background: none;
      border: none;
      color: var(--color-text);
      padding: var(--space-8);
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    .page-header {
      margin-bottom: var(--space-32);
    }

    .page-title {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-8);
    }

    .page-description {
      color: var(--color-text-secondary);
      font-size: var(--font-size-base);
    }

    /* Cards */
    .card {
      background-color: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-24);
      margin-bottom: var(--space-24);
      box-shadow: var(--shadow-sm);
    }

    .card-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-16);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-16);
      margin-bottom: var(--space-24);
    }

    .stat-card {
      background-color: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-20);
      box-shadow: var(--shadow-sm);
    }

    .stat-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-8);
    }

    .stat-value {
      font-size: var(--font-size-2xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-primary);
    }

    /* Forms */
    .form-group {
      margin-bottom: var(--space-20);
    }

    .form-label {
      display: block;
      font-weight: var(--font-weight-medium);
      margin-bottom: var(--space-8);
      font-size: var(--font-size-sm);
    }

    .form-control {
      width: 100%;
      padding: var(--space-12);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      font-size: var(--font-size-base);
      background-color: var(--color-surface);
      color: var(--color-text);
      transition: border-color 0.2s ease;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--color-primary);
    }

    select.form-control {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23134252' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 40px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-16);
    }

    /* Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-12) var(--space-20);
      border-radius: var(--radius-base);
      font-size: var(--font-size-base);
      font-weight: var(--font-weight-medium);
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      text-decoration: none;
      min-height: 44px;
    }

    .btn-primary {
      background-color: var(--color-primary);
      color: var(--color-btn-primary-text);
    }

    .btn-primary:hover {
      background-color: var(--color-primary-hover);
    }

    .btn-secondary {
      background-color: var(--color-secondary);
      color: var(--color-text);
    }

    .btn-secondary:hover {
      background-color: var(--color-secondary-hover);
    }

    .btn-danger {
      background-color: var(--color-error);
      color: white;
    }

    .btn-sm {
      padding: var(--space-8) var(--space-16);
      font-size: var(--font-size-sm);
      min-height: 36px;
    }

    .btn-group {
      display: flex;
      gap: var(--space-12);
      flex-wrap: wrap;
    }

    /* Tables */
    .table-container {
      overflow-x: auto;
      margin-top: var(--space-16);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm);
    }

    th, td {
      padding: var(--space-12);
      text-align: left;
      border-bottom: 1px solid var(--color-border);
    }

    th {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-secondary);
      background-color: var(--color-secondary);
    }

    tr:hover {
      background-color: var(--color-secondary);
    }

    .best-pick {
      background-color: var(--color-bg-3);
      border: 2px solid var(--color-success);
      padding: var(--space-20);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-24);
    }

    .best-pick-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--color-success);
      margin-bottom: var(--space-12);
    }

    .best-pick-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--space-12);
    }

    .best-pick-item {
      font-size: var(--font-size-sm);
    }

    .best-pick-label {
      color: var(--color-text-secondary);
      display: block;
    }

    .best-pick-value {
      font-weight: var(--font-weight-semibold);
      font-size: var(--font-size-base);
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background-color: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-32);
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-24);
    }

    .modal-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
    }

    .modal-close {
      font-size: var(--font-size-2xl);
      cursor: pointer;
      background: none;
      border: none;
      color: var(--color-text);
      padding: var(--space-8);
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: var(--space-24);
      right: var(--space-24);
      z-index: 3000;
      display: flex;
      flex-direction: column;
      gap: var(--space-12);
    }

    .toast {
      background-color: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-base);
      padding: var(--space-16);
      box-shadow: var(--shadow-md);
      min-width: 300px;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      border-left: 4px solid var(--color-success);
    }

    .toast.error {
      border-left: 4px solid var(--color-error);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* Settings Page */
    .settings-section {
      margin-bottom: var(--space-32);
    }

    .settings-list {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-8);
      margin-top: var(--space-12);
    }

    .settings-item {
      display: inline-flex;
      align-items: center;
      gap: var(--space-8);
      padding: var(--space-8) var(--space-12);
      background-color: var(--color-secondary);
      border-radius: var(--radius-base);
      font-size: var(--font-size-sm);
    }

    .settings-item-delete {
      cursor: pointer;
      color: var(--color-error);
      font-weight: var(--font-weight-bold);
    }

    .settings-add {
      display: flex;
      gap: var(--space-12);
      margin-bottom: var(--space-16);
    }

    /* Favorites */
    .favorite-card {
      background-color: var(--color-surface);
      border: 1px solid var(--color-card-border);
      border-radius: var(--radius-lg);
      padding: var(--space-20);
      margin-bottom: var(--space-16);
    }

    .favorite-name {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      margin-bottom: var(--space-12);
    }

    .favorite-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--space-12);
      margin-bottom: var(--space-16);
      font-size: var(--font-size-sm);
    }

    .favorite-actions {
      display: flex;
      gap: var(--space-12);
    }

    /* Responsive */
    @media (max-width: 1023px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.mobile-visible {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        width: 100%;
        padding: var(--space-16);
      }

      .mobile-header {
        display: flex;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .form-row {
        grid-template-columns: 1fr;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .modal-content {
        width: 95%;
        padding: var(--space-20);
      }

      .toast-container {
        right: var(--space-12);
        left: var(--space-12);
      }

      .toast {
        min-width: auto;
      }
    }

    .hidden {
      display: none !important;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: var(--space-12);
      margin-top: var(--space-12);
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: var(--space-8);
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .input-file {
      display: none;
    }

    .savings-positive {
      color: var(--color-success);
      font-weight: var(--font-weight-semibold);
    }

    .savings-negative {
      color: var(--color-error);
      font-weight: var(--font-weight-semibold);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <h1 class="sidebar-title">PG Manager</h1>
      </div>
      <nav>
        <div class="nav-item active" data-page="home">
          <span class="nav-icon">üè†</span>
          <span>Home</span>
        </div>
        <div class="nav-item" data-page="companies">
          <span class="nav-icon">üè¢</span>
          <span>Companies</span>
        </div>
        <div class="nav-item" data-page="gateways">
          <span class="nav-icon">üö™</span>
          <span>Gateways</span>
        </div>
        <div class="nav-item" data-page="rates">
          <span class="nav-icon">üí∞</span>
          <span>Rates</span>
        </div>
        <div class="nav-item" data-page="search">
          <span class="nav-icon">üîç</span>
          <span>Search</span>
        </div>
        <div class="nav-item" data-page="favorites">
          <span class="nav-icon">‚≠ê</span>
          <span>Favorites</span>
        </div>
        <div class="nav-item" data-page="settings">
          <span class="nav-icon">‚öôÔ∏è</span>
          <span>Settings</span>
        </div>
        <div class="nav-item" data-page="preferences">
          <span class="nav-icon">üë§</span>
          <span>Preferences</span>
        </div>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="mobile-header">
        <button class="hamburger" id="hamburger">‚ò∞</button>
        <h2 class="sidebar-title">PG Manager</h2>
        <div style="width: 44px;"></div>
      </div>

      <!-- Home Page -->
      <div class="page active" id="home-page">
        <div class="page-header">
          <h1 class="page-title">Find Best Gateway</h1>
          <p class="page-description">Find the best payment gateway for your transaction</p>
        </div>

        <!-- Recommendation Form -->
        <div class="card">
          <h2 class="card-title">Find Best Gateway</h2>
          <form id="recommendation-form">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Card Type *</label>
                <select class="form-control" id="rec-card-type" required>
                  <option value="">Select Card Type</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Card Issuer *</label>
                <select class="form-control" id="rec-card-issuer" required>
                  <option value="">Select Card Issuer</option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Transaction Amount *</label>
                <input type="number" class="form-control" id="rec-amount" placeholder="Enter amount" required min="1">
              </div>
              <div class="form-group">
                <label class="form-label">Transaction Category</label>
                <select class="form-control" id="rec-category">
                  <option value="">All Categories</option>
                </select>
              </div>
            </div>
            <div class="btn-group">
              <button type="submit" class="btn btn-primary">Find Best Gateway</button>
              <button type="button" class="btn btn-secondary" id="save-favorite-btn" style="display: none;">üíæ Save as Favorite</button>
            </div>
          </form>
        </div>

        <!-- Results -->
        <div id="results-container" style="display: none;">
          <div id="best-pick-container"></div>
          <div class="card">
            <h2 class="card-title">All Options (Ranked)</h2>
            <div class="table-container">
              <table id="results-table">
                <thead>
                  <tr>
                    <th>Rank</th>
                    <th>Gateway</th>
                    <th>Company</th>
                    <th>Commission</th>
                    <th>Surcharge</th>
                    <th>Total Charge</th>
                    <th>Savings vs Best</th>
                  </tr>
                </thead>
                <tbody id="results-tbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Companies Page -->
      <div class="page" id="companies-page">
        <div class="page-header">
          <h1 class="page-title">Companies</h1>
          <p class="page-description">Manage payment service provider companies</p>
        </div>
        <div class="card">
          <div class="btn-group">
            <button class="btn btn-primary" id="add-company-btn">+ Add Company</button>
            <button class="btn btn-secondary" id="export-companies-btn">üì• Export CSV</button>
            <button class="btn btn-secondary" id="import-companies-btn">üì§ Import CSV</button>
            <input type="file" class="input-file" id="import-companies-file" accept=".csv">
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Description</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="companies-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Gateways Page -->
      <div class="page" id="gateways-page">
        <div class="page-header">
          <h1 class="page-title">Payment Gateways</h1>
          <p class="page-description">Manage payment gateway configurations</p>
        </div>
        <div class="card">
          <div class="btn-group">
            <button class="btn btn-primary" id="add-gateway-btn">+ Add Gateway</button>
            <button class="btn btn-secondary" id="export-gateways-btn">üì• Export CSV</button>
            <button class="btn btn-secondary" id="import-gateways-btn">üì§ Import CSV</button>
            <input type="file" class="input-file" id="import-gateways-file" accept=".csv">
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Company</th>
                  <th>PG Partner</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="gateways-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Rates Page -->
      <div class="page" id="rates-page">
        <div class="page-header">
          <h1 class="page-title">Commission Rates</h1>
          <p class="page-description">Manage gateway commission rates and fees</p>
        </div>
        <div class="card">
          <div class="btn-group">
            <button class="btn btn-primary" id="add-rate-btn">+ Add Rate</button>
            <button class="btn btn-secondary" id="export-rates-btn">üì• Export CSV</button>
            <button class="btn btn-secondary" id="import-rates-btn">üì§ Import CSV</button>
            <input type="file" class="input-file" id="import-rates-file" accept=".csv">
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Company</th>
                  <th>Gateway</th>
                  <th>Card Type</th>
                  <th>Issuer</th>
                  <th>Category</th>
                  <th>Commission %</th>
                  <th>Surcharge %</th>
                  <th>Min Amount</th>
                  <th>Max Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="rates-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Search Page -->
      <div class="page" id="search-page">
        <div class="page-header">
          <h1 class="page-title">Search</h1>
          <p class="page-description">Search across all data</p>
        </div>
        <div class="card">
          <div class="form-group">
            <label class="form-label">Search</label>
            <input type="text" class="form-control" id="search-input" placeholder="Type to search...">
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Gateway</th>
                  <th>Company</th>
                  <th>Card Type</th>
                  <th>Issuer</th>
                  <th>Commission %</th>
                  <th>Category</th>
                </tr>
              </thead>
              <tbody id="search-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Favorites Page -->
      <div class="page" id="favorites-page">
        <div class="page-header">
          <h1 class="page-title">Favorites</h1>
          <p class="page-description">Your saved search combinations</p>
        </div>
        <div id="favorites-container"></div>
      </div>

      <!-- Settings Page -->
      <div class="page" id="settings-page">
        <div class="page-header">
          <h1 class="page-title">Settings</h1>
          <p class="page-description">Manage categories, card types, and issuers</p>
        </div>

        <div class="card settings-section">
          <h2 class="card-title">Transaction Categories</h2>
          <div class="settings-add">
            <input type="text" class="form-control" id="new-category-input" placeholder="Add new category">
            <button class="btn btn-primary" id="add-category-btn">Add</button>
          </div>
          <div class="settings-list" id="categories-list"></div>
        </div>

        <div class="card settings-section">
          <h2 class="card-title">Card Issuers</h2>
          <div class="settings-add">
            <input type="text" class="form-control" id="new-issuer-input" placeholder="Add new issuer">
            <button class="btn btn-primary" id="add-issuer-btn">Add</button>
          </div>
          <div class="settings-list" id="issuers-list"></div>
        </div>

        <div class="card settings-section">
          <h2 class="card-title">Card Types</h2>
          <div class="settings-add">
            <input type="text" class="form-control" id="new-cardtype-input" placeholder="Add new card type">
            <button class="btn btn-primary" id="add-cardtype-btn">Add</button>
          </div>
          <div class="settings-list" id="cardtypes-list"></div>
        </div>
      </div>

      <!-- Preferences Page -->
      <div class="page" id="preferences-page">
        <div class="page-header">
          <h1 class="page-title">Preferences</h1>
          <p class="page-description">Customize your experience</p>
        </div>

        <div class="card">
          <h2 class="card-title">Default Markup</h2>
          <div class="form-group">
            <label class="form-label">Default Markup Percentage</label>
            <input type="number" class="form-control" id="default-markup" placeholder="0" min="0" step="0.1">
          </div>
        </div>

        <div class="card">
          <h2 class="card-title">Preferred PG Partners</h2>
          <div class="checkbox-group" id="preferred-partners-list"></div>
        </div>

        <div class="card">
          <h2 class="card-title">Data Management</h2>
          <div class="btn-group">
            <button class="btn btn-danger" id="clear-all-data-btn">Clear All Data</button>
            <button class="btn btn-secondary" id="reset-to-defaults-btn">Reset to Defaults</button>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Modals -->
  <!-- Company Modal -->
  <div class="modal" id="company-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="company-modal-title">Add Company</h2>
        <button class="modal-close" onclick="closeModal('company-modal')">√ó</button>
      </div>
      <form id="company-form">
        <input type="hidden" id="company-id">
        <div class="form-group">
          <label class="form-label">Company Name *</label>
          <input type="text" class="form-control" id="company-name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Description</label>
          <input type="text" class="form-control" id="company-description">
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-control" id="company-status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('company-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Gateway Modal -->
  <div class="modal" id="gateway-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="gateway-modal-title">Add Gateway</h2>
        <button class="modal-close" onclick="closeModal('gateway-modal')">√ó</button>
      </div>
      <form id="gateway-form">
        <input type="hidden" id="gateway-id">
        <div class="form-group">
          <label class="form-label">Gateway Name *</label>
          <input type="text" class="form-control" id="gateway-name" required>
        </div>
        <div class="form-group">
          <label class="form-label">Company *</label>
          <select class="form-control" id="gateway-company" required>
            <option value="">Select Company</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">PG Partner *</label>
          <input type="text" class="form-control" id="gateway-partner" required>
        </div>
        <div class="form-group">
          <label class="form-label">Status</label>
          <select class="form-control" id="gateway-status">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
          </select>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('gateway-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Rate Modal -->
  <div class="modal" id="rate-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="rate-modal-title">Add Rate</h2>
        <button class="modal-close" onclick="closeModal('rate-modal')">√ó</button>
      </div>
      <form id="rate-form">
        <input type="hidden" id="rate-index">
        <div class="form-group">
          <label class="form-label">Company *</label>
          <select class="form-control" id="rate-company" required onchange="filterGatewaysByCompany()">
            <option value="">Select Company</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">Gateway *</label>
          <select class="form-control" id="rate-gateway" required>
            <option value="">Select Gateway</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Card Type *</label>
            <select class="form-control" id="rate-card-type" required>
              <option value="">Select Type</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Card Issuer *</label>
            <select class="form-control" id="rate-card-issuer" required>
              <option value="">Select Issuer</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">Category *</label>
          <select class="form-control" id="rate-category" required>
            <option value="">Select Category</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Commission % *</label>
            <input type="number" class="form-control" id="rate-commission" required step="0.01" min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Surcharge %</label>
            <input type="number" class="form-control" id="rate-surcharge" value="0" step="0.01" min="0">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Min Amount *</label>
            <input type="number" class="form-control" id="rate-min" required min="0">
          </div>
          <div class="form-group">
            <label class="form-label">Max Amount *</label>
            <input type="number" class="form-control" id="rate-max" required min="0">
          </div>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('rate-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Favorite Modal -->
  <div class="modal" id="favorite-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Save as Favorite</h2>
        <button class="modal-close" onclick="closeModal('favorite-modal')">√ó</button>
      </div>
      <form id="favorite-form">
        <div class="form-group">
          <label class="form-label">Nickname *</label>
          <input type="text" class="form-control" id="favorite-name" placeholder="e.g., Education Card Payment" required>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-primary">Save</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal('favorite-modal')">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Data Storage - In-memory variables (synced with backend API)
    let companies = [];
    let gateways = [];
    let rates = [];
    let settings = {
      categories: [],
      cardTypes: [],
      cardIssuers: []
    };
    let favorites = [];
    let preferences = {
      defaultMarkup: 0,
      preferredPartners: [],
      displayOptions: {}
    };
    let lastRecommendation = null;
    let isLoading = false;

    // API Base URL (empty for same origin)
    const API_BASE = '';

    // API Helper Functions
    async function apiGet(endpoint) {
      const response = await fetch(`${API_BASE}${endpoint}`);
      if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
      return await response.json();
    }

    async function apiPost(endpoint, data) {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
      return await response.json();
    }

    async function apiPut(endpoint, data) {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
      return await response.json();
    }

    async function apiDelete(endpoint) {
      const response = await fetch(`${API_BASE}${endpoint}`, {
        method: 'DELETE'
      });
      if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
      return await response.json();
    }

    // Load all data from API
    async function loadAllData() {
      try {
        isLoading = true;
        console.log('Loading data from API...');
        
        // Load all data in parallel
        const [companiesData, gatewaysData, ratesData, settingsData, favoritesData] = await Promise.all([
          apiGet('/api/companies'),
          apiGet('/api/gateways'),
          apiGet('/api/rates'),
          apiGet('/api/settings'),
          apiGet('/api/favorites')
        ]);
        
        // Map backend snake_case to frontend camelCase
        companies = companiesData.map(c => ({
          id: c.id,
          name: c.name,
          description: c.description,
          status: c.status
        }));
        
        gateways = gatewaysData.map(g => ({
          id: g.id,
          name: g.name,
          companyId: g.company_id,
          pgPartner: g.pg_partner,
          status: g.status
        }));
        
        rates = ratesData.map(r => ({
          id: r.id,
          gatewayId: r.gateway_id,
          cardType: r.card_type,
          cardIssuer: r.card_issuer,
          category: r.category,
          commission: r.commission,
          surcharge: r.surcharge,
          minAmount: r.min_amount,
          maxAmount: r.max_amount
        }));
        
        settings = settingsData;
        favorites = favoritesData;
        
        console.log('Data loaded successfully:', {
          companies: companies.length,
          gateways: gateways.length,
          rates: rates.length,
          favorites: favorites.length
        });
        
        isLoading = false;
        return true;
      } catch (error) {
        console.error('Failed to load data:', error);
        isLoading = false;
        showToast('Failed to load data from server', 'error');
        return false;
      }
    }

    // Utility Functions
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    function getCompanyById(id) {
      return companies.find(c => c.id === id);
    }

    function getGatewayById(id) {
      return gateways.find(g => g.id === id);
    }

    function getNextId(array) {
      // IDs are now generated by backend, this is just for fallback
      return array.length > 0 ? Math.max(...array.map(item => item.id || 0)) + 1 : 1;
    }

    // Navigation
    function initializeNavigation() {
      const navItems = document.querySelectorAll('.nav-item');
      const pages = document.querySelectorAll('.page');

      navItems.forEach(item => {
        item.addEventListener('click', () => {
          const pageName = item.dataset.page;
          
          navItems.forEach(nav => nav.classList.remove('active'));
          pages.forEach(page => page.classList.remove('active'));
          
          item.classList.add('active');
          document.getElementById(`${pageName}-page`).classList.add('active');
          
          if (window.innerWidth <= 1023) {
            document.getElementById('sidebar').classList.remove('mobile-visible');
          }

          // Refresh page data
          if (pageName === 'companies') renderCompanies();
          else if (pageName === 'gateways') renderGateways();
          else if (pageName === 'rates') renderRates();
          else if (pageName === 'favorites') renderFavorites();
          else if (pageName === 'settings') renderSettings();
          else if (pageName === 'preferences') renderPreferences();
          else if (pageName === 'home') updateStats();
          else if (pageName === 'search') renderSearchResults();
        });
      });

      // Hamburger menu
      document.getElementById('hamburger').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('mobile-visible');
      });
    }

    // Stats
    function updateStats() {
      document.getElementById('stat-companies').textContent = companies.length;
      document.getElementById('stat-gateways').textContent = gateways.length;
      document.getElementById('stat-rates').textContent = rates.length;
      document.getElementById('stat-favorites').textContent = favorites.length;
    }

    // Populate dropdowns
    function populateDropdowns() {
      // Card Types
      const cardTypeSelects = ['rec-card-type', 'rate-card-type'];
      cardTypeSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select Card Type</option>';
        settings.cardTypes.forEach(type => {
          select.innerHTML += `<option value="${type}">${type}</option>`;
        });
        select.value = currentValue;
      });

      // Card Issuers
      const issuerSelects = ['rec-card-issuer', 'rate-card-issuer'];
      issuerSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select Card Issuer</option>';
        settings.cardIssuers.forEach(issuer => {
          select.innerHTML += `<option value="${issuer}">${issuer}</option>`;
        });
        select.value = currentValue;
      });

      // Categories
      const categorySelects = ['rec-category', 'rate-category'];
      categorySelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        const currentValue = select.value;
        if (selectId === 'rec-category') {
          select.innerHTML = '<option value="">All Categories</option>';
        } else {
          select.innerHTML = '<option value="">Select Category</option>';
        }
        settings.categories.forEach(cat => {
          select.innerHTML += `<option value="${cat}">${cat}</option>`;
        });
        select.value = currentValue;
      });

      // Companies for gateway form
      const companySelect = document.getElementById('gateway-company');
      const currentCompany = companySelect.value;
      companySelect.innerHTML = '<option value="">Select Company</option>';
      companies.forEach(company => {
        companySelect.innerHTML += `<option value="${company.id}">${company.name}</option>`;
      });
      companySelect.value = currentCompany;

      // Companies for rate form
      const rateCompanySelect = document.getElementById('rate-company');
      if (rateCompanySelect) {
        const currentRateCompany = rateCompanySelect.value;
        rateCompanySelect.innerHTML = '<option value="">Select Company</option>';
        companies.forEach(company => {
          rateCompanySelect.innerHTML += `<option value="${company.id}">${company.name}</option>`;
        });
        rateCompanySelect.value = currentRateCompany;
      }
    }

    // Filter gateways by company for rate form
    function filterGatewaysByCompany() {
      const companyId = document.getElementById('rate-company').value;
      const gatewaySelect = document.getElementById('rate-gateway');
      gatewaySelect.innerHTML = '<option value="">Select Gateway</option>';
      
      if (companyId) {
        const filteredGateways = gateways.filter(g => g.companyId == companyId);
        filteredGateways.forEach(gateway => {
          gatewaySelect.innerHTML += `<option value="${gateway.id}">${gateway.name}</option>`;
        });
      }
    }

    // Companies CRUD
    function renderCompanies() {
      const tbody = document.getElementById('companies-tbody');
      tbody.innerHTML = '';
      companies.forEach(company => {
        tbody.innerHTML += `
          <tr>
            <td>${company.name}</td>
            <td>${company.description || '-'}</td>
            <td>${company.status}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="editCompany(${company.id})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteCompany(${company.id})">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    function editCompany(id) {
      const company = getCompanyById(id);
      document.getElementById('company-modal-title').textContent = 'Edit Company';
      document.getElementById('company-id').value = company.id;
      document.getElementById('company-name').value = company.name;
      document.getElementById('company-description').value = company.description || '';
      document.getElementById('company-status').value = company.status;
      openModal('company-modal');
    }

    async function deleteCompany(id) {
      if (confirm('Are you sure you want to delete this company?')) {
        try {
          await apiDelete(`/api/companies/${id}`);
          companies = companies.filter(c => c.id !== id);
          renderCompanies();
          updateStats();
          showToast('Company deleted successfully');
        } catch (error) {
          console.error('Error deleting company:', error);
          showToast('Failed to delete company', 'error');
        }
      }
    }

    document.getElementById('add-company-btn').addEventListener('click', () => {
      document.getElementById('company-modal-title').textContent = 'Add Company';
      document.getElementById('company-form').reset();
      document.getElementById('company-id').value = '';
      openModal('company-modal');
    });

    document.getElementById('company-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const id = document.getElementById('company-id').value;
        const companyData = {
          name: document.getElementById('company-name').value,
          description: document.getElementById('company-description').value,
          status: document.getElementById('company-status').value
        };

        if (id) {
          // Update existing company
          await apiPut(`/api/companies/${id}`, companyData);
          showToast('Company updated successfully');
        } else {
          // Create new company
          await apiPost('/api/companies', companyData);
          showToast('Company added successfully');
        }

        closeModal('company-modal');
        // Reload data from database
        await loadData();
      } catch (error) {
        console.error('Error saving company:', error);
        showToast('Failed to save company', 'error');
      }
    });

    // Gateways CRUD
    function renderGateways() {
      const tbody = document.getElementById('gateways-tbody');
      tbody.innerHTML = '';
      gateways.forEach(gateway => {
        const company = getCompanyById(gateway.companyId);
        tbody.innerHTML += `
          <tr>
            <td>${gateway.name}</td>
            <td>${company ? company.name : '-'}</td>
            <td>${gateway.pgPartner}</td>
            <td>${gateway.status}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="editGateway(${gateway.id})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteGateway(${gateway.id})">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    function editGateway(id) {
      const gateway = getGatewayById(id);
      document.getElementById('gateway-modal-title').textContent = 'Edit Gateway';
      document.getElementById('gateway-id').value = gateway.id;
      document.getElementById('gateway-name').value = gateway.name;
      document.getElementById('gateway-company').value = gateway.companyId;
      document.getElementById('gateway-partner').value = gateway.pgPartner;
      document.getElementById('gateway-status').value = gateway.status;
      openModal('gateway-modal');
    }

    async function deleteGateway(id) {
      if (confirm('Are you sure you want to delete this gateway?')) {
        try {
          await apiDelete(`/api/gateways/${id}`);
          gateways = gateways.filter(g => g.id !== id);
          renderGateways();
          updateStats();
          showToast('Gateway deleted successfully');
        } catch (error) {
          console.error('Error deleting gateway:', error);
          showToast('Failed to delete gateway', 'error');
        }
      }
    }

    document.getElementById('add-gateway-btn').addEventListener('click', () => {
      document.getElementById('gateway-modal-title').textContent = 'Add Gateway';
      document.getElementById('gateway-form').reset();
      document.getElementById('gateway-id').value = '';
      populateDropdowns();
      openModal('gateway-modal');
    });

    document.getElementById('gateway-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const id = document.getElementById('gateway-id').value;
        const gatewayData = {
          name: document.getElementById('gateway-name').value,
          company_id: parseInt(document.getElementById('gateway-company').value),
          pg_partner: document.getElementById('gateway-partner').value,
          status: document.getElementById('gateway-status').value
        };

        if (id) {
          // Update existing gateway
          await apiPut(`/api/gateways/${id}`, gatewayData);
          showToast('Gateway updated successfully');
        } else {
          // Create new gateway
          await apiPost('/api/gateways', gatewayData);
          showToast('Gateway added successfully');
        }

        closeModal('gateway-modal');
        // Reload data from database
        await loadData();
      } catch (error) {
        console.error('Error saving gateway:', error);
        showToast('Failed to save gateway', 'error');
      }
    });

    // Rates CRUD
    function renderRates() {
      const tbody = document.getElementById('rates-tbody');
      tbody.innerHTML = '';
      rates.forEach((rate, index) => {
        const gateway = getGatewayById(rate.gatewayId);
        const company = gateway ? getCompanyById(gateway.companyId) : null;
        tbody.innerHTML += `
          <tr>
            <td>${company ? company.name : '-'}</td>
            <td>${gateway ? gateway.name : '-'}</td>
            <td>${rate.cardType}</td>
            <td>${rate.cardIssuer}</td>
            <td>${rate.category}</td>
            <td>${rate.commission}%</td>
            <td>${rate.surcharge}%</td>
            <td>${rate.minAmount}</td>
            <td>${rate.maxAmount}</td>
            <td>
              <button class="btn btn-sm btn-secondary" onclick="editRate(${index})">Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteRate(${index})">Delete</button>
            </td>
          </tr>
        `;
      });
    }

    function editRate(index) {
      const rate = rates[index];
      const gateway = getGatewayById(rate.gatewayId);
      document.getElementById('rate-modal-title').textContent = 'Edit Rate';
      document.getElementById('rate-index').value = index;
      
      // Set company first
      if (gateway) {
        document.getElementById('rate-company').value = gateway.companyId;
        filterGatewaysByCompany();
      }
      
      document.getElementById('rate-gateway').value = rate.gatewayId;
      document.getElementById('rate-card-type').value = rate.cardType;
      document.getElementById('rate-card-issuer').value = rate.cardIssuer;
      document.getElementById('rate-category').value = rate.category;
      document.getElementById('rate-commission').value = rate.commission;
      document.getElementById('rate-surcharge').value = rate.surcharge;
      document.getElementById('rate-min').value = rate.minAmount;
      document.getElementById('rate-max').value = rate.maxAmount;
      openModal('rate-modal');
    }

    async function deleteRate(index) {
      if (confirm('Are you sure you want to delete this rate?')) {
        try {
          const rate = rates[index];
          await apiDelete(`/api/rates/${rate.id}`);
          rates.splice(index, 1);
          renderRates();
          updateStats();
          showToast('Rate deleted successfully');
        } catch (error) {
          console.error('Error deleting rate:', error);
          showToast('Failed to delete rate', 'error');
        }
      }
    }

    document.getElementById('add-rate-btn').addEventListener('click', () => {
      document.getElementById('rate-modal-title').textContent = 'Add Rate';
      document.getElementById('rate-form').reset();
      document.getElementById('rate-index').value = '';
      populateDropdowns();
      openModal('rate-modal');
    });

    document.getElementById('rate-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const index = document.getElementById('rate-index').value;
        const rateData = {
          gateway_id: parseInt(document.getElementById('rate-gateway').value),
          card_type: document.getElementById('rate-card-type').value,
          card_issuer: document.getElementById('rate-card-issuer').value,
          category: document.getElementById('rate-category').value,
          commission: parseFloat(document.getElementById('rate-commission').value),
          surcharge: parseFloat(document.getElementById('rate-surcharge').value),
          min_amount: parseFloat(document.getElementById('rate-min').value),
          max_amount: parseFloat(document.getElementById('rate-max').value)
        };

        if (index !== '') {
          // Update existing rate
          const rate = rates[parseInt(index)];
          await apiPut(`/api/rates/${rate.id}`, rateData);
          showToast('Rate updated successfully');
        } else {
          // Create new rate
          await apiPost('/api/rates', rateData);
          showToast('Rate added successfully');
        }

        closeModal('rate-modal');
        // Reload data from database
        await loadData();
      } catch (error) {
        console.error('Error saving rate:', error);
        showToast('Failed to save rate', 'error');
      }
    });

    // Recommendation Engine
    document.getElementById('recommendation-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const cardType = document.getElementById('rec-card-type').value;
      const cardIssuer = document.getElementById('rec-card-issuer').value;
      const amount = parseFloat(document.getElementById('rec-amount').value);
      const category = document.getElementById('rec-category').value;

      // Find matching rates
      let matchingRates = rates.filter(rate => {
        const matchesType = rate.cardType === cardType;
        const matchesIssuer = rate.cardIssuer === cardIssuer;
        const matchesAmount = amount >= rate.minAmount && amount <= rate.maxAmount;
        const matchesCategory = !category || rate.category === category;
        return matchesType && matchesIssuer && matchesAmount && matchesCategory;
      });

      if (matchingRates.length === 0) {
        showToast('No matching gateways found', 'error');
        document.getElementById('results-container').style.display = 'none';
        document.getElementById('save-favorite-btn').style.display = 'none';
        return;
      }

      // Calculate total charges and sort (both commission and surcharge are percentages)
      const results = matchingRates.map(rate => {
        const gateway = getGatewayById(rate.gatewayId);
        const company = getCompanyById(gateway.companyId);
        const commissionAmount = (amount * rate.commission) / 100;
        const surchargeAmount = (amount * rate.surcharge) / 100;
        const totalChargeAmount = commissionAmount + surchargeAmount;
        const totalPercentage = rate.commission + rate.surcharge;
        return {
          rate,
          gateway,
          company,
          commissionAmount,
          surchargeAmount,
          totalChargeAmount,
          totalPercentage,
          netAmount: amount - totalChargeAmount
        };
      }).sort((a, b) => a.totalChargeAmount - b.totalChargeAmount);

      const bestOption = results[0];

      // Save last recommendation
      lastRecommendation = {
        cardType,
        cardIssuer,
        amount,
        category,
        results
      };

      // Display best pick
      const bestPickContainer = document.getElementById('best-pick-container');
      bestPickContainer.innerHTML = `
        <div class="best-pick">
          <div class="best-pick-title">üèÜ Best Pick: ${bestOption.gateway.name}</div>
          <div class="best-pick-details">
            <div class="best-pick-item">
              <span class="best-pick-label">Company</span>
              <span class="best-pick-value">${bestOption.company.name}</span>
            </div>
            <div class="best-pick-item">
              <span class="best-pick-label">Commission</span>
              <span class="best-pick-value">${bestOption.rate.commission}% (‚Çπ${bestOption.commissionAmount.toFixed(2)})</span>
            </div>
            <div class="best-pick-item">
              <span class="best-pick-label">Surcharge</span>
              <span class="best-pick-value">${bestOption.rate.surcharge}% (‚Çπ${bestOption.surchargeAmount.toFixed(2)})</span>
            </div>
            <div class="best-pick-item">
              <span class="best-pick-label">Total Charge</span>
              <span class="best-pick-value">${bestOption.totalPercentage.toFixed(2)}% (‚Çπ${bestOption.totalChargeAmount.toFixed(2)})</span>
            </div>
            <div class="best-pick-item">
              <span class="best-pick-label">Net Amount</span>
              <span class="best-pick-value">‚Çπ${bestOption.netAmount.toFixed(2)}</span>
            </div>
          </div>
        </div>
      `;

      // Display all options
      const tbody = document.getElementById('results-tbody');
      tbody.innerHTML = '';
      results.forEach((result, index) => {
        const savings = result.totalChargeAmount - bestOption.totalChargeAmount;
        const savingsClass = savings > 0 ? 'savings-negative' : 'savings-positive';
        const savingsText = savings === 0 ? 'Best' : `+‚Çπ${savings.toFixed(2)}`;
        tbody.innerHTML += `
          <tr>
            <td>${index + 1}</td>
            <td>${result.gateway.name}</td>
            <td>${result.company.name}</td>
            <td>${result.rate.commission}% (‚Çπ${result.commissionAmount.toFixed(2)})</td>
            <td>${result.rate.surcharge}% (‚Çπ${result.surchargeAmount.toFixed(2)})</td>
            <td>${result.totalPercentage.toFixed(2)}% (‚Çπ${result.totalChargeAmount.toFixed(2)})</td>
            <td class="${savingsClass}">${savingsText}</td>
          </tr>
        `;
      });

      document.getElementById('results-container').style.display = 'block';
      document.getElementById('save-favorite-btn').style.display = 'inline-flex';
    });

    // Favorites
    document.getElementById('save-favorite-btn').addEventListener('click', () => {
      openModal('favorite-modal');
      document.getElementById('favorite-name').value = '';
    });

    document.getElementById('favorite-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const name = document.getElementById('favorite-name').value;
        const rec = lastRecommendation;
        
        if (!rec) return;

        const favoriteData = {
          name,
          card_type: rec.cardType,
          card_issuer: rec.cardIssuer,
          amount: rec.amount,
          category: rec.category || 'All Categories'
        };

        const savedFavorite = await apiPost('/api/favorites', favoriteData);
        favorites.push(savedFavorite);
        
        closeModal('favorite-modal');
        showToast('Favorite saved successfully');
        updateStats();
      } catch (error) {
        console.error('Error saving favorite:', error);
        showToast('Failed to save favorite', 'error');
      }
    });

    function renderFavorites() {
      const container = document.getElementById('favorites-container');
      if (favorites.length === 0) {
        container.innerHTML = '<div class="card"><p>No favorites saved yet.</p></div>';
        return;
      }

      container.innerHTML = '';
      favorites.forEach(fav => {
        const cardType = fav.card_type || fav.cardType;
        const cardIssuer = fav.card_issuer || fav.cardIssuer;
        container.innerHTML += `
          <div class="favorite-card">
            <div class="favorite-name">${fav.name}</div>
            <div class="favorite-details">
              <div><strong>Card Type:</strong> ${cardType}</div>
              <div><strong>Issuer:</strong> ${cardIssuer}</div>
              <div><strong>Amount:</strong> ‚Çπ${fav.amount}</div>
              <div><strong>Category:</strong> ${fav.category}</div>
            </div>
            <div class="favorite-actions">
              <button class="btn btn-sm btn-primary" onclick="useFavorite(${fav.id})">Use This</button>
              <button class="btn btn-sm btn-danger" onclick="deleteFavorite(${fav.id})">Delete</button>
            </div>
          </div>
        `;
      });
    }

    function useFavorite(id) {
      const fav = favorites.find(f => f.id === id);
      if (!fav) return;

      document.getElementById('rec-card-type').value = fav.card_type || fav.cardType;
      document.getElementById('rec-card-issuer').value = fav.card_issuer || fav.cardIssuer;
      document.getElementById('rec-amount').value = fav.amount;
      document.getElementById('rec-category').value = fav.category === 'All Categories' ? '' : fav.category;

      // Switch to home page
      document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
      document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
      document.querySelector('[data-page="home"]').classList.add('active');
      document.getElementById('home-page').classList.add('active');

      showToast('Favorite loaded into form');
    }

    async function deleteFavorite(id) {
      if (confirm('Are you sure you want to delete this favorite?')) {
        try {
          await apiDelete(`/api/favorites/${id}`);
          favorites = favorites.filter(f => f.id !== id);
          renderFavorites();
          updateStats();
          showToast('Favorite deleted successfully');
        } catch (error) {
          console.error('Error deleting favorite:', error);
          showToast('Failed to delete favorite', 'error');
        }
      }
    }

    // Settings
    function renderSettings() {
      // Categories
      const categoriesList = document.getElementById('categories-list');
      categoriesList.innerHTML = '';
      settings.categories.forEach(cat => {
        categoriesList.innerHTML += `
          <div class="settings-item">
            <span>${cat}</span>
            <span class="settings-item-delete" onclick="deleteCategory('${cat}')">√ó</span>
          </div>
        `;
      });

      // Issuers
      const issuersList = document.getElementById('issuers-list');
      issuersList.innerHTML = '';
      settings.cardIssuers.forEach(issuer => {
        issuersList.innerHTML += `
          <div class="settings-item">
            <span>${issuer}</span>
            <span class="settings-item-delete" onclick="deleteIssuer('${issuer}')">√ó</span>
          </div>
        `;
      });

      // Card Types
      const typesList = document.getElementById('cardtypes-list');
      typesList.innerHTML = '';
      settings.cardTypes.forEach(type => {
        typesList.innerHTML += `
          <div class="settings-item">
            <span>${type}</span>
            <span class="settings-item-delete" onclick="deleteCardType('${type}')">√ó</span>
          </div>
        `;
      });
    }

    document.getElementById('add-category-btn').addEventListener('click', async () => {
      const input = document.getElementById('new-category-input');
      const value = input.value.trim();
      if (value && !settings.categories.includes(value)) {
        try {
          settings.categories.push(value);
          await apiPut('/api/settings', settings);
          input.value = '';
          renderSettings();
          populateDropdowns();
          showToast('Category added successfully');
        } catch (error) {
          settings.categories.pop();
          console.error('Error adding category:', error);
          showToast('Failed to add category', 'error');
        }
      }
    });

    document.getElementById('add-issuer-btn').addEventListener('click', async () => {
      const input = document.getElementById('new-issuer-input');
      const value = input.value.trim();
      if (value && !settings.cardIssuers.includes(value)) {
        try {
          settings.cardIssuers.push(value);
          await apiPut('/api/settings', settings);
          input.value = '';
          renderSettings();
          populateDropdowns();
          showToast('Issuer added successfully');
        } catch (error) {
          settings.cardIssuers.pop();
          console.error('Error adding issuer:', error);
          showToast('Failed to add issuer', 'error');
        }
      }
    });

    document.getElementById('add-cardtype-btn').addEventListener('click', async () => {
      const input = document.getElementById('new-cardtype-input');
      const value = input.value.trim();
      if (value && !settings.cardTypes.includes(value)) {
        try {
          settings.cardTypes.push(value);
          await apiPut('/api/settings', settings);
          input.value = '';
          renderSettings();
          populateDropdowns();
          showToast('Card type added successfully');
        } catch (error) {
          settings.cardTypes.pop();
          console.error('Error adding card type:', error);
          showToast('Failed to add card type', 'error');
        }
      }
    });

    async function deleteCategory(cat) {
      if (confirm(`Delete category "${cat}"?`)) {
        try {
          const oldCategories = [...settings.categories];
          settings.categories = settings.categories.filter(c => c !== cat);
          await apiPut('/api/settings', settings);
          renderSettings();
          populateDropdowns();
          showToast('Category deleted successfully');
        } catch (error) {
          settings.categories = oldCategories;
          console.error('Error deleting category:', error);
          showToast('Failed to delete category', 'error');
        }
      }
    }

    async function deleteIssuer(issuer) {
      if (confirm(`Delete issuer "${issuer}"?`)) {
        try {
          const oldIssuers = [...settings.cardIssuers];
          settings.cardIssuers = settings.cardIssuers.filter(i => i !== issuer);
          await apiPut('/api/settings', settings);
          renderSettings();
          populateDropdowns();
          showToast('Issuer deleted successfully');
        } catch (error) {
          settings.cardIssuers = oldIssuers;
          console.error('Error deleting issuer:', error);
          showToast('Failed to delete issuer', 'error');
        }
      }
    }

    async function deleteCardType(type) {
      if (confirm(`Delete card type "${type}"?`)) {
        try {
          const oldTypes = [...settings.cardTypes];
          settings.cardTypes = settings.cardTypes.filter(t => t !== type);
          await apiPut('/api/settings', settings);
          renderSettings();
          populateDropdowns();
          showToast('Card type deleted successfully');
        } catch (error) {
          settings.cardTypes = oldTypes;
          console.error('Error deleting card type:', error);
          showToast('Failed to delete card type', 'error');
        }
      }
    }

    // Preferences
    function renderPreferences() {
      document.getElementById('default-markup').value = preferences.defaultMarkup;

      // Get unique PG partners
      const partners = [...new Set(gateways.map(g => g.pgPartner))];
      const partnersList = document.getElementById('preferred-partners-list');
      partnersList.innerHTML = '';
      partners.forEach(partner => {
        const checked = preferences.preferredPartners.includes(partner) ? 'checked' : '';
        partnersList.innerHTML += `
          <div class="checkbox-item">
            <input type="checkbox" id="partner-${partner}" value="${partner}" ${checked}>
            <label for="partner-${partner}">${partner}</label>
          </div>
        `;
      });

      // Add event listeners
      partnersList.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', () => {
          const partner = cb.value;
          if (cb.checked) {
            if (!preferences.preferredPartners.includes(partner)) {
              preferences.preferredPartners.push(partner);
            }
          } else {
            preferences.preferredPartners = preferences.preferredPartners.filter(p => p !== partner);
          }
          // Note: Preferences are client-side only for now
        });
      });
    }

    document.getElementById('default-markup').addEventListener('change', async (e) => {
      preferences.defaultMarkup = parseFloat(e.target.value) || 0;
      // Note: Preferences are client-side only for now, could be extended to API
      showToast('Markup updated (client-side only)', 'success');
    });

    document.getElementById('clear-all-data-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        alert('Please clear data directly from the database or restart the server.');
        showToast('Data management via API - use database tools', 'error');
      }
    });

    document.getElementById('reset-to-defaults-btn').addEventListener('click', async () => {
      if (confirm('Reset all data to SLPE defaults?')) {
        try {
          // Reload data from backend (backend should have defaults)
          await loadAllData();
          populateDropdowns();
          updateStats();
          renderCompanies();
          showToast('Data reloaded from server');
        } catch (error) {
          console.error('Error resetting data:', error);
          showToast('Failed to reset data', 'error');
        }
      }
    })

    // Search
    function renderSearchResults() {
      const query = document.getElementById('search-input').value.toLowerCase();
      const tbody = document.getElementById('search-tbody');
      
      const results = [];
      rates.forEach(rate => {
        const gateway = getGatewayById(rate.gatewayId);
        const company = gateway ? getCompanyById(gateway.companyId) : null;
        
        // If no query, show all results
        if (!query) {
          results.push({ rate, gateway, company });
        } else {
          const searchText = [
            gateway?.name,
            company?.name,
            rate.cardType,
            rate.cardIssuer,
            rate.category,
            rate.commission.toString()
          ].join(' ').toLowerCase();

          if (searchText.includes(query)) {
            results.push({ rate, gateway, company });
          }
        }
      });

      tbody.innerHTML = '';
      results.forEach(result => {
        tbody.innerHTML += `
          <tr>
            <td>${result.gateway?.name || '-'}</td>
            <td>${result.company?.name || '-'}</td>
            <td>${result.rate.cardType}</td>
            <td>${result.rate.cardIssuer}</td>
            <td>${result.rate.commission}%</td>
            <td>${result.rate.category}</td>
          </tr>
        `;
      });
    }

    document.getElementById('search-input').addEventListener('input', () => {
      renderSearchResults();
    });

    // CSV Export - Fixed version
    function exportToCSV(data, filename) {
      const csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      showToast(`Exported ${data.length - 1} items successfully`, 'success');
    }

    document.getElementById('export-companies-btn').addEventListener('click', () => {
      const data = [['Name', 'Description']];
      companies.forEach(c => {
        data.push([c.name, c.description || '']);
      });
      exportToCSV(data, 'companies.csv');
    });

    document.getElementById('export-gateways-btn').addEventListener('click', () => {
      const data = [['Name', 'Company', 'PG Partner']];
      gateways.forEach(g => {
        const company = getCompanyById(g.companyId);
        data.push([g.name, company?.name || '', g.pgPartner]);
      });
      exportToCSV(data, 'gateways.csv');
    });

    document.getElementById('export-rates-btn').addEventListener('click', () => {
      const data = [['Gateway', 'Card Type', 'Issuer', 'Category', 'Commission', 'Surcharge', 'Min', 'Max']];
      rates.forEach(r => {
        const gateway = getGatewayById(r.gatewayId);
        data.push([
          gateway?.name || '',
          r.cardType,
          r.cardIssuer,
          r.category,
          r.commission,
          r.surcharge,
          r.minAmount,
          r.maxAmount
        ]);
      });
      exportToCSV(data, 'rates.csv');
    });

    // CSV Import
    document.getElementById('import-companies-btn').addEventListener('click', () => {
      document.getElementById('import-companies-file').click();
    });

    document.getElementById('import-gateways-btn').addEventListener('click', () => {
      document.getElementById('import-gateways-file').click();
    });

    document.getElementById('import-rates-btn').addEventListener('click', () => {
      document.getElementById('import-rates-file').click();
    });

    document.getElementById('import-companies-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const csv = event.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          let imported = 0;
          
          // Skip header line
          for (let i = 1; i < lines.length; i++) {
            // Handle quoted CSV values
            const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
            const name = values[0];
            const description = values[1] || '';
            
            if (name) {
              companies.push({
                id: getNextId(companies),
                name,
                description,
                status: 'active'
              });
              imported++;
            }
          }
          
          saveToLocalStorage();
          renderCompanies();
          populateDropdowns();
          updateStats();
          showToast(`Imported ${imported} companies successfully`, 'success');
        } catch (error) {
          console.error('Import error:', error);
          showToast('Error importing CSV. Check file format.', 'error');
        }
        e.target.value = '';
      };
      reader.readAsText(file);
    });

    document.getElementById('import-gateways-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const csv = event.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          let imported = 0;
          
          // Skip header line
          for (let i = 1; i < lines.length; i++) {
            // Handle quoted CSV values
            const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
            const name = values[0];
            const companyName = values[1];
            const pgPartner = values[2] || '';
            
            const company = companies.find(c => c.name === companyName);
            if (name && company) {
              gateways.push({
                id: getNextId(gateways),
                name,
                companyId: company.id,
                pgPartner,
                status: 'active'
              });
              imported++;
            }
          }
          
          saveToLocalStorage();
          renderGateways();
          populateDropdowns();
          updateStats();
          showToast(`Imported ${imported} gateways successfully`, 'success');
        } catch (error) {
          console.error('Import error:', error);
          showToast('Error importing CSV. Check file format.', 'error');
        }
        e.target.value = '';
      };
      reader.readAsText(file);
    });

    document.getElementById('import-rates-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const csv = event.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          let imported = 0;
          
          // Skip header line
          for (let i = 1; i < lines.length; i++) {
            // Handle quoted CSV values
            const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
            const gatewayName = values[0];
            const cardType = values[1];
            const issuer = values[2];
            const category = values[3];
            const commission = values[4];
            const surcharge = values[5];
            const min = values[6];
            const max = values[7];
            
            const gateway = gateways.find(g => g.name === gatewayName);
            if (gateway && cardType && issuer && category) {
              rates.push({
                gatewayId: gateway.id,
                cardType,
                cardIssuer: issuer,
                category,
                commission: parseFloat(commission) || 0,
                surcharge: parseFloat(surcharge) || 0,
                minAmount: parseFloat(min) || 0,
                maxAmount: parseFloat(max) || 0
              });
              imported++;
            }
          }
          
          saveToLocalStorage();
          renderRates();
          updateStats();
          showToast(`Imported ${imported} rates successfully`, 'success');
        } catch (error) {
          console.error('Import error:', error);
          showToast('Error importing CSV. Check file format.', 'error');
        }
        e.target.value = '';
      };
      reader.readAsText(file);
    });

    // Initialize App
    async function initializeApp() {
      console.log('Initializing app...');
      
      // Show loading state
      document.body.insertAdjacentHTML('afterbegin', `
        <div id="loading-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--color-background); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column;">
          <div style="font-size: var(--font-size-2xl); color: var(--color-primary); margin-bottom: var(--space-16);">Loading...</div>
          <div style="color: var(--color-text-secondary);">Fetching data from server</div>
        </div>
      `);
      
      try {
        // STEP 1: Load all data from API
        await loadAllData();
        
        // STEP 2: Initialize navigation and UI
        initializeNavigation();
        populateDropdowns();
        updateStats();
        renderCompanies();
        
        console.log('App initialized successfully');
      } catch (error) {
        console.error('Failed to initialize app:', error);
        showToast('Failed to load application data', 'error');
      } finally {
        // Remove loading overlay
        const overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.remove();
      }
    }

    // Start the app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeApp);
    } else {
      initializeApp();
    }
  </script>
</body>
</html>
